<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Components</title>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

    <div class="container mt-4">

        <!-- Title + Create button -->
        <h1 class="d-flex justify-content-between align-items-center">
            Components
            <!-- Create Component Button -->
            <button class="btn btn-primary"
                hx-get="{% url 'component_create' %}"
                hx-target="#modal-body-container"
                hx-trigger="click"
                data-bs-toggle="modal"
                data-bs-target="#create-component-modal">
            Create Component
        </button>




        </h1>

        <!-- Modal container -->
       <div id="create-component-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create Component</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modal-body-container">
                        <!-- HTMX injects form here -->
                    </div>
                </div>
            </div>
        </div>


        <!-- Table controls -->
        <form id="table-controls" hx-get="{% url 'component_table' %}" hx-target="#component-table-body"
            hx-swap="innerHTML" hx-trigger="input delay:200ms, change">

            <div class="row mb-3 g-2">
                <div class="col-md-6">
                    <input type="text" name="filter_identifier" class="form-control"
                        placeholder="Filter by identifier..." value="{{ current_filter_identifier|default:'' }}">
                </div>

                <div class="col-md-6">
                    <select name="filter_inventory_level" class="form-select">
                        <option value="">All inventory levels</option>
                        {% for lvl in inventory_levels %}
                        <option value="{{ lvl.id }}" {% if lvl.id|stringformat:"s" == current_inventory_level %}selected{%endif %}>
                            {{ lvl.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Hidden sort inputs -->
            <input type="hidden" name="sort" id="sort-field" value="{{ current_sort|default:'id' }}">
            <input type="hidden" name="dir" id="sort-dir" value="{{ current_dir|default:'asc' }}">
        </form>

        <!-- Table headers -->
        <table class="table table-striped" style="table-layout: fixed; width: 100%;">
            <thead>
                <tr>
                    <!-- Identifier column -->
                    <th style="cursor:pointer;" hx-get="{% url 'component_table' %}" hx-target="#component-table-body"
                        hx-swap="innerHTML" hx-include="#table-controls" onclick="
            let sortInput = document.getElementById('sort-field');
            let dirInput = document.getElementById('sort-dir');
            if(sortInput.value==='identifier'){
              dirInput.value = dirInput.value==='asc' ? 'desc' : 'asc';
            } else {
              sortInput.value='identifier';
              dirInput.value='asc';
            }
          ">
                        Identifier ↑↓
                    </th>

                    <!-- Inventory Level column -->
                    <th style="cursor:pointer;" hx-get="{% url 'component_table' %}" hx-target="#component-table-body"
                        hx-swap="innerHTML" hx-include="#table-controls" onclick="
            let sortInput = document.getElementById('sort-field');
            let dirInput = document.getElementById('sort-dir');
            if(sortInput.value==='inventory_level'){
              dirInput.value = dirInput.value==='asc' ? 'desc' : 'asc';
            } else {
              sortInput.value='inventory_level';
              dirInput.value='asc';
            }
          ">
                        Inventory Level ↑↓
                    </th>

                    <th>Description</th>
                </tr>
            </thead>
            <tbody id="component-table-body"
                hx-get="{% url 'component_table' %}"
                hx-trigger="load"
                hx-swap="innerHTML">
                <!-- Table rows injected here -->
            </tbody>

        </table>



    </div>
</body>

<script>
document.body.addEventListener('htmx:afterSwap', (event) => {
    if (event.detail.xhr.getResponseHeader('HX-Trigger') === 'componentCreated') {
        // Close modal
        const modalEl = document.getElementById('create-component-modal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        // Refresh table
        htmx.ajax('GET', '{% url "component_table" %}', {target: '#component-table-body'});
    }
});
</script>



</html>